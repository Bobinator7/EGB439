%% Test 

clear;close all;clc;

% robot init
pb = startup_robot('192.168.43.154');


% EKF init
idx = [];
mu = [0;0;0];
sigma = 0.01*eye(3);

% distress call
load('map1.mat');

target = [0.5;0.5];
[mu,sigma,idx] = toPoint(pb, target, mu, sigma, idx);
% 
target_angle = deg2rad(170);
[mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
target_angle = deg2rad(0);
[mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);

target = [1;1];
[mu,sigma,idx] = toPoint(pb, target, mu, sigma, idx);
% 
target_angle = deg2rad(170); 
[mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
target_angle = deg2rad(0);
[mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
% 
if (size(idx,1)==5)
    disp('5 beacons found - 1st time')
    distCallLoc = getDistressCall(map,mu,idx);
    [mu,sigma,idx] = toPoint(pb, distCallLoc, mu, sigma, idx);
    hold on; plot(distCallLoc,'x')
    return
end

% target = [1;1.25];
% [mu,sigma,idx] = toPoint(pb, target, mu, sigma, idx);
% target_angle = deg2rad(180); 
% [mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
% target_angle = deg2rad(0);
% [mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
% 
% if (size(idx,1)==5)
%     disp('5 beacons found - 2nd time')
%     distCallLoc = getDistressCall(map1,mu,idx);
%     [mu,sigma,idx] = toPoint(pb, distCallLoc, mu, sigma, idx);
%     hold on; plot(distCallLoc,'x')
%     return
% end
% 
% target = [1;0.75];
% [mu,sigma,idx] = toPoint(pb, target, mu, sigma, idx);
% target_angle = deg2rad(-180); 
% [mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);
% target_angle = deg2rad(0);
% [mu,sigma,idx] = rotate(pb, target_angle, mu, sigma, idx);


disp('shit did not find it')


% target = [0;0];
% [mu,sigma,idx] = toPoint(pb, target, mu, sigma, idx);

% optional: plotting function coord frame

% TODO: fix scale
% TODO: clean up graph
% TODO: right better main function (i.e., fully rotate)
% TODO: plot distress call location
% TODO: FINISH!!!!!!!

